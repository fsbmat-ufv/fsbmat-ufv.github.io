---
title: "Covid19 in Brazil"
author: "Prof. Fernando de Souza Bastos"
output: 
  flexdashboard::flex_dashboard:
    orientation: column
    social: menu
    source_code: embed
    vertical_layout: scroll
runtime: shiny
---

```{r global, include=FALSE}
library("readr")
library("dplyr")
library("tidyverse")
library("treemap")
library("flexdashboard")
library("DT")
library("ggplot2")
options(DT.options = list(scrollY="100vh"))
library("dplyr")
library("tidyr")
library("hrbrthemes")
library("ggrepel")
library("shinythemes")
library("rio")
#library(miceadds)
#setwd("~/GitHub/fsbmat-ufv.github.io/blog_posts/26-03-2020/Shiny/Corona")
#data <- read_csv(url("https://rawcdn.githack.com/fsbmat-ufv/fsbmat-ufv.github.io/fcba93f491ed21eba0628471649eb9a5bda033f2/blog_posts/26-03-2020/Corona/covid19.csv"))
#export(data, "covid19.rdata")
#load(url("https://rawcdn.githack.com/fsbmat-ufv/fsbmat-ufv.github.io/a16ef0fe0a27374cdbb7f88106c080ca0cd2ded3/blog_posts/26-03-2020/Corona/covid19.RData"))
data <- read.csv("covid19.csv")
export(data, "covid19.rdata")
load("covid19.rdata")
data <- x
rm(x)


data$deaths[is.na(data$deaths)] <- 0
data$date <- as.Date(data$date)
data <- data[order(data$date) , ]

data <- data %>%
  dplyr::filter(place_type == "state") %>%
  dplyr::group_by(state,date, confirmed,deaths) %>% 
  select(date, state, confirmed, deaths, estimated_population_2019)
names(data) <- c("date", "state", "confirmed", "deaths", "Pop")

aggSetor <-data%>%filter(date==(last(data$date)-1))%>%group_by(state) %>% 
  summarise(quantidade = sum(deaths), confirmedM = mean(confirmed))
aggSetor$escala <- scale(aggSetor$confirmedM) 

```


Sidebar {.sidebar}
=====================================

This Fleshdashboard was created to facilitate the visualization of data about Covid19 in the States of Brazil.

```{r}
selectInput("codeInput",label ="Escolha um Estado",
                      choices = unique(data$state))

dataset<-reactive({ 
        subset(data, state == input$codeInput)
    
    
  })
  
  HTML(
      '<div id="stats_header">
			Coronavirus in Brazil
			<a href="https://maf105.github.io/" target="_blank"><img align="right" alt="fsbmat Logo" src="./img/fsbmat.png" /></a>
			</div>'
    )
  
  dataset2<-reactive({
    df <- dataset()
    teste1 <- dplyr::lag(df$deaths)
    teste1[is.na(teste1)] <- 0
    teste2 <- dplyr::lag(df$confirmed)
    teste2[is.na(teste2)] <- 0
    df$teste1 <- teste1
    df$teste2 <- teste2
    df$deaths_day <- df$deaths-df$teste1
    df$confirmed_day <- df$confirmed-df$teste2
    df <- df %>% select(1:5,8:9)
    return(df)
  })
  
  dataset3 <- reactive({
    ndeaths <- data %>% group_by(date) %>% summarise(deaths = sum(deaths))
    return(ndeaths)
  })
  
  dataset4 <- reactive({
    nconfirmed <- data %>% group_by(date) %>% summarise(confirmed = sum(confirmed))
    return(nconfirmed)
  })

```

Page 1
=====================================  


### Dataframe of Covid19 in Brasil 
    
```{r}

  
  # # output$caption and output$mpgPlot functions
  # formulaText <- reactive({
  #   paste("Results Regarding the State of", input$codeInput)
  # })
  # 
  # # Return the formula text for printing as a caption ----
  # renderText({
  #   formulaText()
  # })
  
  DT::renderDataTable({

    DT::datatable(dataset(), options = list(list(scrollY="300px"
                                                 , scrollX="300px"
                                                 , pageLength = 100
                                                 ))
                               ,  filter = 'top')

  })

  
  
```

Page 2
===================================== 

### Numbers of Deaths in State 
    
```{r}
renderPlot({
    xlab <- "Data"
    legenda <- "fonte: https://brasil.io/dataset/covid19/caso"
    
    ggplot2::ggplot(dataset(), aes(x = date, y = deaths)) +
      geom_bar(stat = "identity", alpha = .7, color = "red", fill = "red") +
      scale_x_date(date_breaks = "1 day",
                   date_labels = "%d/%m") +
      scale_y_continuous(limits = c(0, max(dataset()$deaths+20, na.rm = TRUE) + 3),
                         expand = c(0, 0)) +
      geom_text(aes(label=deaths), position=position_dodge(width=0.9), vjust=-0.25) +
      labs(x = xlab,
           y = "Numbers of Deaths",
           title = "Number of deaths by COVID-19",
           caption = legenda) +
      theme_minimal() +
      theme(axis.text.x =  element_text(angle = 90))
    
  })
```

Page 3
===================================== 

### Number of Confirmed Cases

```{r}
renderPlot({
    xlab <- "Data"
    legenda <- "fonte: https://brasil.io/dataset/covid19/caso"
    
    ggplot2::ggplot(dataset(), aes(x = date, y = confirmed)) +
      geom_bar(stat = "identity", alpha = .7, color = "red", fill = "red") +
      scale_x_date(date_breaks = "1 day",
                   date_labels = "%d/%m") +
      scale_y_continuous(limits = c(0, max(dataset()$confirmed+100, na.rm = TRUE) + 3),
                         expand = c(0, 0)) +
      geom_text(aes(label=confirmed), position=position_dodge(width=0.9), vjust=-0.25) +
      labs(x = xlab,
           y = "Numbers of Confirmed",
           title = "Number of Cases Confirmed with Covid19",
           caption = legenda) +
      theme_minimal() +
      theme(axis.text.x =  element_text(angle = 90))
    
  })
```



Page 4
===================================== 

### Number of Confirmed Daily Cases

```{r}
renderPlot({
    xlab <- "Data"
    legenda <- "fonte: https://brasil.io/dataset/covid19/caso"
    
    #Graph with the number of confirmed daily cases
    ggplot(dataset2(), aes(x=date, y=confirmed_day))+
      geom_line( color="steelblue")+ 
      geom_point() + 
      geom_text_repel(aes(label=confirmed_day), size = 3)+
      xlab("Data") + ylab("Number of confirmed daily cases")+
      theme_ipsum() +
      theme(axis.text.x=element_text(angle=60, hjust=1))+
      scale_x_date(date_breaks = "2 day", date_labels = "%d %b")
    
    
    
    
  })
```


Brasil
===================================== 

Column
-------------------------------------

### Number of Deaths by Covid19 in Brazil

```{r}
renderPlot({
    xlab <- "Data"
    legenda <- "fonte: https://brasil.io/dataset/covid19"
    
    ggplot2::ggplot(dataset3(), aes(x = date, y = deaths)) +
      geom_bar(stat = "identity", alpha = .7, color = "red", fill = "red") +
      scale_x_date(date_breaks = "1 day",
                   date_labels = "%d/%m") +
      scale_y_continuous(limits = c(0, max(dataset3()$deaths+20, na.rm = TRUE) + 3),
                         expand = c(0, 0)) +
      geom_text(aes(label=deaths), position=position_dodge(width=0.9), vjust=-0.25) +
      labs(x = xlab,
           y = "Number of Deaths",
           title = " ",
           caption = legenda) +
      theme_minimal() +
      theme(axis.text.x =  element_text(angle = 90))
  })


```

### Number of Confirmed with Covid19 in Brazil

```{r}
renderPlot({
    xlab <- "Data"
    legenda <- "fonte: https://brasil.io/dataset/covid19/caso"
    ggplot2::ggplot(dataset4(), aes(x = date, y = confirmed)) +
      geom_bar(stat = "identity", alpha = .7, color = "red", fill = "red") +
      scale_x_date(date_breaks = "1 day",
                   date_labels = "%d/%m") +
      scale_y_continuous(limits = c(0, max(dataset4()$confirmed+300, na.rm = TRUE) + 3),
                         expand = c(0, 0)) +
      geom_text(aes(label=confirmed), position=position_dodge(width=0.5), vjust=-0.25) +
      labs(x = xlab,
           y = "Number of Confirmed",
           title = " ",
           caption = legenda) +
      theme_minimal() +
      theme(axis.text.x =  element_text(angle = 90))
  })

```

### Treemap of deaths and number of confirmed by State (Last day)

```{r}
renderPlot({
    treemap(aggSetor, index = "state", vSize = "quantidade", vColor = "escala",
            type = "value", palette = "-RdGy", lowerbound.cex.labels = 0.3,
            title  =  "Color related to deaths - Size related to confirmed")
  })
```

